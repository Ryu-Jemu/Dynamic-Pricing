# O-RAN 1-Cell Slicing + Pricing with SB3 SAC (Monthly)

Reference-grade simulation for joint network slice pricing and PRB allocation
using Soft Actor-Critic reinforcement learning.

## Quick Start

```bash
chmod +x run.sh && ./run.sh
```

This executes the full pipeline: venv setup → calibration → tests → training → evaluation → report.

## Architecture

```
├── config/
│   ├── default.yaml          # All scenario parameters (configurable)
│   └── calibrated.yaml       # Auto-generated by calibration
├── src/
│   ├── models/
│   │   ├── utils.py          # Config I/O, price bounds, math utilities
│   │   ├── radio.py          # PRB allocation, congestion model (§10)
│   │   ├── demand.py         # Log-normal demand with quantile fitting (§9)
│   │   ├── pools.py          # User pool management with strict invariants (§8)
│   │   ├── topup.py          # Throttle logic, probabilistic top-up (§11)
│   │   ├── market.py         # Join/churn with disconfirmation (§13)
│   │   ├── economics.py      # SLA, energy, profit, reward (§12,14,15)
│   │   ├── safety.py         # NaN/Inf detection, violation penalties
│   │   └── calibrate.py      # Demand/market/reward calibration (§19)
│   ├── envs/
│   │   └── oran_slicing_env.py   # Gymnasium environment (§16-17)
│   ├── train_sac.py          # SB3 SAC training (§18)
│   ├── eval.py               # Multi-repeat evaluation (§18)
│   └── report.py             # Plots + report.md generation (§18)
├── tests/
│   ├── test_invariants.py    # Pool disjointness + conservation (§20)
│   ├── test_monotonicity.py  # Radio monotone degradation (§20)
│   ├── test_finite_reward.py # No NaN/Inf under random actions (§20)
│   └── test_calibration.py   # Calibration target verification (§20)
├── run.sh                    # End-to-end pipeline (§21)
├── requirements.txt
└── README.md
```

## Problem Description

A single 5G NR base station (100 MHz @ 30 kHz SCS, 273 PRBs) serves two network slices:

- **eMBB** (enhanced Mobile Broadband): high-throughput consumer data
- **URLLC** (Ultra-Reliable Low-Latency): mission-critical services

An RL agent (SAC) makes three decisions each month:

| Action | Description | Range |
|--------|-------------|-------|
| `a[0]` | Monthly fee F_eMBB | [0.8×F_min, 1.2×F_max] KRW |
| `a[1]` | Monthly fee F_URLLC | [0.8×F_min, 1.2×F_max] KRW |
| `a[2]` | URLLC PRB share ρ_URLLC | [0.05, 0.95] |

The agent optimizes monthly profit (revenue − costs) while maintaining SLA compliance
and managing user churn through pricing and resource allocation.

## Monthly Step Order (§17 — fixed)

1. **Map action** → fees + PRB share (bounds enforced)
2. **Join**: new users arrive (Poisson), inactive → active
3. **Demand**: sample monthly data volumes (log-normal)
4. **Inner loop** (K=30 micro-steps): compute utilization, throughput, violations
5. **Aggregate** monthly KPIs
6. **Top-up** + disconfirmation update
7. **Churn**: dissatisfied users leave, active → churned
8. **Profit/reward** computation
9. **Log** all metrics

## Key Design Decisions

### Price Bounds (±20% exploration)
Agent-controlled fees range ±20% beyond the plan catalog bounds.
This is a *learning stabilization assumption* for the scenario — not a market constraint.
Controlled via `action.price_explore_factor` in config.

### Calibration (§19)
All numeric parameters are calibrated, not hardcoded:

- **Demand**: log-normal μ, σ fitted to target p50/p90 quantiles
- **Market**: logistic churn offset U_outside solved to match target baseline churn rates (3–4%)
- **Reward scale**: profit_scale = p95(|profit|) from random policy rollouts

### Radio Abstraction
We use macro capacity proxies (not full PHY MCS/TBS chain).
Throughput degrades monotonically with load via a congestion function calibrated
to literature profiles.

### Standards-Pinned Constants
| Parameter | Value | Source |
|-----------|-------|--------|
| Bandwidth | 100 MHz | TS 38.104 |
| SCS | 30 kHz | TS 38.104 |
| PRB total | 273 | TS 38.104 (NRB table) |

## Configuration

All parameters are in `config/default.yaml`. Key sections:

- `radio`: bandwidth, PRB count, cell capacity, congestion
- `time`: episode length (50 months), inner loop K=30
- `plans`: eMBB/URLLC plan catalogs (Korean-style monthly plans)
- `demand`: target quantiles per slice
- `market`: churn/join parameters, segment sensitivities
- `training`: SAC hyperparameters (lr, batch size, etc.)
- `calibration`: tolerance thresholds

## Device Selection

Prefers MPS (Apple Silicon GPU) if available; falls back to CPU.
Printed at pipeline start.

## Outputs (per run in `artifacts/<run_id>/`)

| File | Description |
|------|-------------|
| `config.yaml` | Config snapshot |
| `meta.json` | Run metadata (device, timing) |
| `train_log.csv` | Per-episode training metrics |
| `eval_monthly.csv` | Per-month eval metrics (all repeats) |
| `eval_summary.json` | Mean±std across repeats |
| `best_model/` | Best checkpoint (by eval reward) |
| `final_model.zip` | Final model after all timesteps |
| `report.md` | Summary report with plots |
| `plots/` | 6 PNG plots |

### Plots Generated

1. **Profit / Revenue / Cost** — monthly economic dynamics
2. **Subscription Fees** — agent pricing decisions by slice
3. **PRB Share & Utilization** — resource allocation and load
4. **Average Throughput** — QoS per slice
5. **SLA Violation Rates** — compliance tracking
6. **Churn / Join / Active Users** — market dynamics

## Tests

```bash
python -m unittest discover -s tests -v
```

| Test File | What it Tests | Section |
|-----------|---------------|---------|
| `test_invariants.py` | Pool disjointness, conservation, transition correctness | §20 |
| `test_monotonicity.py` | T_eff decreasing in load, violations non-decreasing | §20 |
| `test_finite_reward.py` | No NaN/Inf under random actions across seeds | §20 |
| `test_calibration.py` | Demand/market/reward calibration targets met | §20 |

## References

| Tag | Source |
|-----|--------|
| [SAC] | Haarnoja et al., *Soft Actor-Critic*, ICML 2018 |
| [SB3_SAC] | Stable-Baselines3 SAC documentation |
| [SB3_TIPS] | SB3 RL Tips and Tricks |
| [TS38104] | 3GPP TS 38.104 — NR Base Station radio transmission and reception |
| [TS38214] | 3GPP TS 38.214 — NR Physical layer procedures for data |
| [LOGNORMAL_TNET] | Mobile data traffic modeling, IEEE/ACM Trans. Netw. 2021 |
| [CHURN_SLR] | Telecom churn determinants SLR, Springer 2023 |
| [DISCONF_PDF] | Disconfirmation in continuance, Int. J. Contents 2021 |
| [BS_POWER] | Base station power consumption models |
| [CONG_5G_PMC] | 5G congestion and throughput degradation, PMC 2023 |
| [VERIZON_SLA] | Verizon SLA credit tiers (MRC-based) |
| [TWORLD_18] | T World plan page (post-cap speed restriction) |

## License

Research / educational use. Not for production deployment.
